<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de CPU - Arquitectura Cl√°sica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .mono { font-family: 'Roboto Mono', monospace; }
        .component {
            border: 2px solid #4b5563;
            border-radius: 0.5rem;
            padding: 0.5rem;
            background-color: #1f2937;
            transition: all 0.3s ease-in-out;
            position: absolute;
            text-align: center;
            z-index: 10;
        }
        .bus {
            position: absolute;
            z-index: 1;
            transition: background-color 0.3s ease-in-out;
        }
        .bus-label {
            position: absolute;
            font-weight: bold;
            z-index: 20;
            text-shadow: 0 0 5px #111827;
        }
        .highlight-component {
            background-color: #facc15 !important;
            color: #1f2937 !important;
            transform: scale(1.05);
            box-shadow: 0 0 15px #facc15;
        }
        
        /* Bus Colors from reference diagram */
        .bus-addr { background-color: #8b5cf6; } /* Purple */
        .bus-data { background-color: #10b981; } /* Green */
        .bus-ctrl { background-color: #0ea5e9; } /* Light Blue */
        
        /* Highlight colors from reference diagram */
        .highlight-bus-address { background-color: #ef4444 !important; } /* Red */
        .highlight-bus-data { background-color: #ef4444 !important; } /* Red for data flow */
        .highlight-bus-control { background-color: #3b82f6 !important; } /* Blue for control flow */

        /* Fix for content visibility when highlighted */
        .highlight-component * {
            color: #1f2937 !important;
        }
        .highlight-component #memoria-content {
            background-color: transparent !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Simulador de CPU</h1>
            <p class="text-lg text-gray-400">Visualizaci√≥n de la suma A + B con arquitectura de microprocesador de 16 bits</p>
        </header>

        <!-- Controles -->
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-8 flex flex-col sm:flex-row items-center justify-center gap-4">
            <div class="flex items-center gap-2">
                <label for="valA" class="font-medium text-white">Valor A:</label>
                <input type="number" id="valA" value="5" class="w-24 bg-gray-700 text-white rounded p-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-400">
            </div>
            <div class="flex items-center gap-2">
                <label for="valB" class="font-medium text-white">Valor B:</label>
                <input type="number" id="valB" value="3" class="w-24 bg-gray-700 text-white rounded p-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-400">
            </div>
            <button id="autoRunBtn" class="w-full sm:w-auto bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-lg hover:bg-yellow-300 transition-colors">Ejecuci√≥n Autom√°tica</button>
            <button id="nextStepBtn" class="w-full sm:w-auto bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-400 transition-colors">Siguiente Paso</button>
            <button id="resetSim" class="w-full sm:w-auto bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-400 transition-colors">Reiniciar</button>
        </div>

        <!-- Layout Principal -->
        <div class="flex flex-col gap-8">
            <!-- Diagrama -->
            <div class="relative w-full border-4 border-gray-700 rounded-xl min-h-[750px] p-4 bg-gray-900 bg-opacity-50">
                
                <!-- Contenedor del Microprocesador -->
                <div class="absolute" style="left: 20%; right: 20%; top: 20px; height: 480px; border: 2px solid #6b7280; border-radius: 1rem; background-color: rgba(31, 41, 55, 0.5);">
                     <h2 class="absolute top-2 left-4 text-xl font-bold text-gray-500">Microprocesador de 16 bits</h2>
                </div>

                <!-- COMPONENTES -->
                <div id="pc" class="component" style="top: 150px; left: 25%;"><h3 class="font-bold">Contador (PC)</h3><p class="mono mt-1">0x1000</p></div>
                <div id="uc" class="component" style="top: 250px; left: 45%; width: 140px; height: 100px;"><h3 class="font-bold">Unidad Control</h3><h4 class="text-sm text-gray-400">(Decodificador)</h4><p id="uc-opcode-display" class="mono text-yellow-300 mt-1 text-xs">-</p></div>
                <div id="ri" class="component" style="top: 380px; left: 35%; width: 180px;"><h3 class="font-bold">Registro Inst. (RI)</h3><p class="mono mt-1 text-xs">-</p></div>
                <div id="acumulador" class="component bg-red-900" style="top: 100px; left: 58%;"><h3 class="font-bold">Acumulador</h3><p class="mono mt-1">0</p></div>
                <div id="operando2" class="component" style="top: 180px; left: 58%;"><h3 class="font-bold">Operando 2</h3><p class="mono mt-1">0</p></div>
                <div id="alu" class="component" style="top: 130px; left: 70%; width: 100px; height: 100px;"><h3 class="font-bold text-xl">ALU</h3></div>
                
                <div id="memoria" class="component" style="top: 550px; left: 30%; width: 200px; height: 150px;"><h3 class="font-bold">Memoria</h3><div id="memoria-content" class="text-left overflow-y-auto h-28 mt-1 bg-gray-800 p-1 rounded"></div></div>
                <div id="io" class="component" style="top: 550px; right: 30%;"><h3 class="font-bold">Entradas/Salidas</h3></div>
                
                <div id="encoding-table" class="component" style="top: 30px; right: 1%; width: 180px;">
                    <h3 class="font-bold">Codificaci√≥n</h3>
                    <div id="encoding-content-data" class="text-left mono mt-1 text-xs"></div>
                    <div id="encoding-content-inst" class="text-left mono mt-1 text-xs border-t border-gray-600 pt-1"></div>
                </div>

                <!-- BUSES Y ETIQUETAS -->
                <!-- Bus de Direcciones -->
                <div id="bus-addr-main" class="bus bus-addr" style="left: 15%; top: 170px; width: 8px; height: 408px;"></div>
                <div id="bus-addr-pc-conn" class="bus bus-addr" style="top: 170px; left: 15%; width: 10%; height: 8px;"></div>
                <div id="bus-addr-ext-conn" class="bus bus-addr" style="top: 570px; left: 15%; width: 55%; height: 8px;"></div>
                <p class="bus-label text-red-500" style="top: 140px; left: 14%;">Direcci√≥n</p>
                <p class="bus-label" style="top: 370px; left: 11%; transform: rotate(-90deg); color: #a78bfa;">BUS DE DIRECCIONES</p>

                <!-- Bus de Datos -->
                <div id="bus-data-main" class="bus bus-data" style="left: 30%; top: 260px; width: 8px; height: 348px;"></div>
                <div id="bus-data-internal-horz" class="bus bus-data" style="top: 260px; left: 30%; width: 25%; height: 8px;"></div>
                <div id="bus-data-internal-vert" class="bus bus-data" style="left: 55%; top: 100px; width: 8px; height: 168px;"></div>
                <div id="bus-data-ri-conn" class="bus bus-data" style="top: 400px; left: 30%; width: 5%; height: 8px;"></div>
                <div id="bus-data-acum-conn" class="bus bus-data" style="top: 120px; left: 55%; width: 3%; height: 8px;"></div>
                <div id="bus-data-op2-conn" class="bus bus-data" style="top: 200px; left: 55%; width: 3%; height: 8px;"></div>
                <div id="bus-data-alu-conn" class="bus bus-data" style="top: 170px; left: 55%; width: 15%; height: 8px;"></div>
                <div id="bus-data-ext-conn" class="bus bus-data" style="top: 600px; left: 30%; width: 33%; height: 8px;"></div>
                <p class="bus-label text-red-500" style="top: 480px; left: 25%;">Datos</p>
                <p class="bus-label" style="top: 450px; left: 26%; transform: rotate(-90deg); color: #34d399;">BUS DE DATOS</p>
                
                <!-- Bus de Control -->
                <div id="bus-control-main" class="bus bus-ctrl" style="right: 15%; top: 300px; width: 8px; height: 338px;"></div>
                <div id="bus-control-uc-conn" class="bus bus-ctrl" style="top: 300px; left: 59%; right: 15%; height: 8px;"></div>
                <div id="bus-control-ext-conn" class="bus bus-ctrl" style="top: 630px; left: 50%; right: 15%; height: 8px;"></div>
                <p class="bus-label" style="top: 480px; right: 16%; transform: rotate(-90deg); color: #38bdf8;">BUS DE CONTROL</p>
            </div>

            <!-- Log -->
            <div id="log" class="component w-full min-h-[300px] bg-gray-900 p-4 overflow-y-auto" style="position: relative; top: 0; left: 0;">
                <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Registro de Simulaci√≥n</h2>
                <div id="log-content"><p class="text-gray-500">Esperando inicio...</p></div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const autoRunBtn = document.getElementById('autoRunBtn');
        const nextStepBtn = document.getElementById('nextStepBtn');
        const resetBtn = document.getElementById('resetSim');
        const valAInput = document.getElementById('valA');
        const valBInput = document.getElementById('valB');
        const logContent = document.getElementById('log-content');
        const encodingContentData = document.getElementById('encoding-content-data');
        const encodingContentInst = document.getElementById('encoding-content-inst');
        const pcEl = document.getElementById('pc'), riEl = document.getElementById('ri'), ucEl = document.getElementById('uc'), aluEl = document.getElementById('alu'), acumuladorEl = document.getElementById('acumulador'), operando2El = document.getElementById('operando2'), memoriaEl = document.getElementById('memoria-content');
        const ucOpcodeDisplay = document.getElementById('uc-opcode-display');

        // --- Simulation State & Config ---
        let memory = {};
        const ADDR_A = '0x0001', ADDR_B = '0x0002', ADDR_RESULT = '0x0003', PROG_START = 0x1000, SIM_SPEED = 750;
        let stepQueue = [];
        let isAutoRunning = false;
        
        const program = [
            { addr: '0x1000', inst: 'LOAD_A', opcode: '0001', hexcode: '0x1', val: ADDR_A },
            { addr: '0x1001', inst: 'ADD',    opcode: '0010', hexcode: '0x2', val: ADDR_B },
            { addr: '0x1002', inst: 'STORE',  opcode: '0011', hexcode: '0x3', val: ADDR_RESULT },
            { addr: '0x1003', inst: 'HALT',   opcode: '1111', hexcode: '0xF', val: null }
        ];

        // --- Functions ---
        function to16BitBinary(num) {
            return num.toString(2).padStart(16, '0');
        }
        function updateDataEncodingTable() {
            const valA = parseInt(valAInput.value, 10) || 0;
            const valB = parseInt(valBInput.value, 10) || 0;
            encodingContentData.innerHTML = `
                <b>Datos:</b>
                <p>Valor A (${valA}): ${to16BitBinary(valA)}</p>
                <p>Valor B (${valB}): ${to16BitBinary(valB)}</p>
            `;
        }
        function updateInstructionEncodingTable() {
            encodingContentInst.innerHTML = '<b>Instrucciones (Opcode):</b>';
            program.forEach(p => {
                if (p.inst) {
                    encodingContentInst.innerHTML += `<p>${p.inst}: ${p.hexcode} (${p.opcode})</p>`;
                }
            });
        }

        function setupMemory() {
            memory = {};
            // Initialize a block of data memory with zeros
            for (let i = 0; i < 16; i++) {
                const addr = '0x' + i.toString(16).padStart(4, '0');
                memory[addr] = 0;
            }
            
            memory[ADDR_A] = parseInt(valAInput.value, 10) || 0;
            memory[ADDR_B] = parseInt(valBInput.value, 10) || 0;
            memory[ADDR_RESULT] = 0;
            program.forEach(p => { memory[p.addr] = p; });
            renderMemory();
            updateDataEncodingTable();
            updateInstructionEncodingTable();
        }
        function renderMemory() {
            memoriaEl.innerHTML = '';
            const allAddresses = Object.keys(memory).sort((a, b) => parseInt(a, 16) - parseInt(b, 16));

            const dataAddresses = allAddresses.filter(addr => parseInt(addr, 16) < PROG_START);
            const programAddresses = allAddresses.filter(addr => parseInt(addr, 16) >= PROG_START);

            dataAddresses.forEach(addr => {
                 const val = memory[addr];
                 const displayVal = typeof val === 'object' ? val.inst : val;
                 memoriaEl.innerHTML += `<div id="mem-${addr}" class="mono p-1 rounded text-xs"><b>${addr}:</b> ${displayVal}</div>`;
            });
             memoriaEl.innerHTML += `<div class="my-1 border-t border-gray-700"></div>`; // Separator
            programAddresses.forEach(addr => {
                 const val = memory[addr];
                 const displayVal = typeof val === 'object' ? val.inst : val;
                 memoriaEl.innerHTML += `<div id="mem-${addr}" class="mono p-1 rounded text-xs"><b>${addr}:</b> ${displayVal}</div>`;
            });
        }
        function updateRegister(el, value) { el.querySelector('p').textContent = value; }
        function addLog(message, isStep = true) {
            const stepPrefix = isStep ? `<b>[Paso ${logContent.children.length + 1}]</b> ` : '';
            logContent.innerHTML += `<p class="mb-2 p-2 bg-gray-800 rounded-md shadow">${stepPrefix}${message}</p>`;
            logContent.scrollTop = logContent.scrollHeight;
        }

        const busPaths = {
            address: ['bus-addr-main', 'bus-addr-pc-conn', 'bus-addr-ext-conn'],
            data: ['bus-data-main', 'bus-data-internal-horz', 'bus-data-internal-vert', 'bus-data-ri-conn', 'bus-data-alu-conn', 'bus-data-ext-conn', 'bus-data-acum-conn', 'bus-data-op2-conn'],
            control: ['bus-control-main', 'bus-control-uc-conn', 'bus-control-ext-conn']
        };
        function highlight(elements, type) {
            const highlightClass = `highlight-bus-${type}`;
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add(highlightClass);
            });
        }
        function highlightComponent(ids) {
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('highlight-component');
            });
        }

        function unhighlightAll() {
            const classes = ['highlight-component', 'highlight-bus-address', 'highlight-bus-data', 'highlight-bus-control'];
            document.querySelectorAll('.' + classes.join(', .')).forEach(el => el.classList.remove(...classes));
        }
        
        function addStep(logMessage, actionFn, keepHighlights = false) {
            stepQueue.push(async () => {
                if (!keepHighlights) {
                    unhighlightAll();
                }
                addLog(logMessage);
                if (actionFn) actionFn();
            });
        }
        
        function getMachineCode(instruction) {
             if (instruction.inst === 'HALT') {
                return instruction.opcode.padEnd(16, '0');
            }
            const addrHex = instruction.val.substring(2);
            const addrInt = parseInt(addrHex, 16);
            const addrBinary = addrInt.toString(2).padStart(12, '0');
            return instruction.opcode + addrBinary;
        }

        function prepareSimulation() {
            stepQueue = [];
            let tempPC = PROG_START;
            let tempAcumulador = 0;
            setupMemory(); 

            for(const instruction of program) {
                 if (instruction.inst === 'HALT') {
                    addStep("‚úÖ **FIN:** El programa ha terminado. El resultado final est√° resaltado en la memoria.", () => {
                        disableButtons();
                    }, true); // Keep final highlight
                    break;
                }
                const currentPCStr = `0x${tempPC.toString(16)}`;
                const operandAddr = instruction.val;
                const machineCode = getMachineCode(instruction);
                
                // --- ETAPA 1: LECTURA (FETCH) ---
                 addStep(`<b>1. Lectura (Fetch):</b> El procesador busca en memoria la instrucci√≥n indicada por el PC (${currentPCStr}).`, () => {
                    updateRegister(pcEl, currentPCStr);
                    highlight([...busPaths.address], 'address');
                    highlightComponent(['pc', 'memoria']);
                });
                addStep(`... üß© El c√≥digo m√°quina (<span class="mono">${machineCode}</span>) pasa al Registro de Instrucci√≥n (RI).`, () => {
                    highlight([...busPaths.data], 'data');
                    highlightComponent(['memoria', 'ri']);
                    updateRegister(riEl, machineCode);
                    ucOpcodeDisplay.textContent = '-';
                });
                
                // --- ETAPA 2: DECODIFICACI√ìN (DECODE) ---
                addStep(`<b>2. Decodificaci√≥n (Decode):</b> ‚öôÔ∏è La UC interpreta el c√≥digo m√°quina del RI.`, () => {
                    highlightComponent(['uc', 'ri']);
                    ucOpcodeDisplay.textContent = machineCode;
                });

                // --- ETAPA 3: INCREMENTO DEL PC ---
                addStep(`<b>3. Incremento del PC (PC++):</b> üî¢ El PC incrementa su valor para apuntar a la siguiente instrucci√≥n.`, () => {
                    highlightComponent(['pc']);
                    updateRegister(pcEl, `0x${(tempPC + 1).toString(16)}`);
                });

                // --- ETAPA 4: EJECUCI√ìN (EXECUTE) ---
                addStep(`<b>4. Ejecuci√≥n (Execute):</b> üì§ Se ejecuta la instrucci√≥n "${instruction.inst}".`, () => {
                    highlightComponent(['uc']);
                    highlight([...busPaths.control], 'control');
                });

                switch (instruction.inst) {
                    case 'LOAD_A':
                        const valA = memory[operandAddr];
                        addStep(`... La UC usa la direcci√≥n ${operandAddr} para buscar el dato en Memoria.`, () => {
                            highlight([...busPaths.address], 'address');
                            highlightComponent(['uc', 'memoria']);
                        });
                        addStep(`... El valor (${valA}), representado como <code>${to16BitBinary(valA)}</code>, viaja de la Memoria al Acumulador.`, () => {
                            highlight([...busPaths.data], 'data');
                            highlightComponent(['memoria', 'acumulador']);
                            tempAcumulador = valA;
                            updateRegister(acumuladorEl, tempAcumulador);
                        });
                        break;
                    case 'ADD':
                         const valB = memory[operandAddr];
                         addStep(`... La UC usa la direcci√≥n ${operandAddr} para buscar el dato en Memoria.`, () => {
                            highlight([...busPaths.address], 'address');
                            highlightComponent(['uc', 'memoria']);
                        });
                        addStep(`... El valor (${valB}), representado como <code>${to16BitBinary(valB)}</code>, viaja de la Memoria al Operando 2.`, () => {
                            highlight([...busPaths.data], 'data');
                            highlightComponent(['memoria', 'operando2']);
                            updateRegister(operando2El, valB);
                        });
                        addStep(`... La ALU suma Acumulador (${tempAcumulador}) y Operando 2 (${valB}).`, () => {
                           highlightComponent(['acumulador', 'operando2', 'alu']);
                        });
                        addStep(`... El resultado (${Number(tempAcumulador) + Number(valB)}) se guarda en el Acumulador.`, () => {
                            tempAcumulador = Number(tempAcumulador) + Number(valB);
                            highlight([...busPaths.data], 'data');
                            highlightComponent(['alu', 'acumulador']);
                            updateRegister(acumuladorEl, tempAcumulador);
                        });
                        break;
                    case 'STORE':
                        const result = tempAcumulador;
                        addStep(`... El Acumulador pone el resultado (${result}), representado como <code>${to16BitBinary(result)}</code>, en el Bus de Datos.`, () => {
                             highlight([...busPaths.data], 'data');
                             highlightComponent(['acumulador', 'memoria']);
                        });
                        addStep(`... La UC env√≠a la direcci√≥n de destino (${operandAddr}) y la se√±al de 'escribir'.`, () => {
                             highlight([...busPaths.address, ...busPaths.control], 'control');
                             highlight([...busPaths.address], 'address');
                             highlightComponent(['uc', 'memoria']);
                            memory[ADDR_RESULT] = tempAcumulador;
                            renderMemory();
                            document.getElementById('mem-' + ADDR_RESULT).classList.add('highlight-component');
                        });
                        break;
                }
                tempPC++;
            }
        }
        
        function ensureSimulationIsPrepared() {
            if (stepQueue.length === 0) {
                logContent.innerHTML = ''; 
                prepareSimulation();
            }
        }

        async function executeNextStep() {
            ensureSimulationIsPrepared();
            if (stepQueue.length > 0) {
                nextStepBtn.disabled = true;
                const step = stepQueue.shift();
                await step();
                if (stepQueue.length > 0) {
                    nextStepBtn.disabled = false;
                } else {
                    disableButtons();
                }
            }
        }
        
        async function autoRun() {
            ensureSimulationIsPrepared();
            isAutoRunning = true;
            disableButtons(true);
            while(isAutoRunning && stepQueue.length > 0) {
                const step = stepQueue.shift();
                await step();
                await new Promise(resolve => setTimeout(resolve, SIM_SPEED));
            }
            if (stepQueue.length === 0) {
                 disableButtons();
            }
        }
        
        function disableButtons(autoRunning = false){
            autoRunBtn.disabled = true;
            nextStepBtn.disabled = true;
            if(autoRunning) resetBtn.disabled = true;
        }

        function resetState() {
             isAutoRunning = false;
             stepQueue = []; 
             unhighlightAll();
             
             updateRegister(pcEl, `0x${PROG_START.toString(16)}`);
             updateRegister(riEl, '-');
             updateRegister(acumuladorEl, '0');
             updateRegister(operando2El, '0');
             ucOpcodeDisplay.textContent = '-';
             logContent.innerHTML = '<p class="text-gray-500" style="text-align: center;">Presiona "Siguiente Paso" o "Ejecuci√≥n Autom√°tica"</p>';
             
             setupMemory();
             
             autoRunBtn.disabled = false;
             nextStepBtn.disabled = false;
             resetBtn.disabled = false;
        }
        
        // --- Event Listeners ---
        autoRunBtn.addEventListener('click', autoRun);
        nextStepBtn.addEventListener('click', executeNextStep);
        resetBtn.addEventListener('click', resetState);
        valAInput.addEventListener('input', resetState);
        valBInput.addEventListener('input', resetState);
        
        // --- Initial Setup ---
        resetState();
    </script>
</body>
</html>






