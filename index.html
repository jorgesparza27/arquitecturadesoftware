<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de CPU - Arquitectura 16 bits</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .mono { font-family: 'Roboto Mono', monospace; }
        .component {
            border: 2px solid #4b5563;
            border-radius: 0.5rem;
            padding: 0.5rem;
            background-color: #1f2937;
            transition: all 0.3s ease-in-out;
            position: absolute;
            text-align: center;
            z-index: 10;
        }
        .bus {
            position: absolute;
            background-color: #6b7280;
            z-index: 1;
            transition: background-color 0.3s ease-in-out;
        }
        .bus-label {
            position: absolute;
            font-weight: bold;
            z-index: 2;
            text-shadow: 0 0 5px #111827;
        }
        .bus-main {
             background-color: #374151;
             z-index: 0;
        }
        .highlight-component {
            background-color: #facc15 !important;
            color: #1f2937 !important;
            transform: scale(1.05);
            box-shadow: 0 0 15px #facc15;
        }
        .highlight-bus-address { background-color: #ef4444 !important; }
        .highlight-bus-data { background-color: #3b82f6 !important; }
        .highlight-bus-control { background-color: #22c55e !important; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Simulador de CPU</h1>
            <p class="text-lg text-gray-400">Visualización de la suma A + B con arquitectura de microprocesador de 16 bits</p>
        </header>

        <!-- Controles -->
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-8 flex flex-col sm:flex-row items-center justify-center gap-4">
            <div class="flex items-center gap-2">
                <label for="valA" class="font-medium text-white">Valor A:</label>
                <input type="number" id="valA" value="5" class="w-24 bg-gray-700 text-white rounded p-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-400">
            </div>
            <div class="flex items-center gap-2">
                <label for="valB" class="font-medium text-white">Valor B:</label>
                <input type="number" id="valB" value="3" class="w-24 bg-gray-700 text-white rounded p-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-400">
            </div>
            <button id="autoRunBtn" class="w-full sm:w-auto bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-lg hover:bg-yellow-300 transition-colors">Ejecución Automática</button>
            <button id="nextStepBtn" class="w-full sm:w-auto bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-400 transition-colors">Siguiente Paso</button>
            <button id="resetSim" class="w-full sm:w-auto bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-400 transition-colors">Reiniciar</button>
        </div>

        <!-- Layout Principal -->
        <div class="flex flex-col gap-8">
            <!-- Diagrama -->
            <div class="relative w-full border-4 border-gray-700 rounded-xl min-h-[700px] p-4 bg-gray-900 bg-opacity-50">
                
                <!-- Contenedor del Microprocesador -->
                <div class="absolute inset-x-32 top-8 bottom-48 border-2 border-dashed border-gray-600 rounded-lg">
                     <h2 class="absolute top-2 left-4 text-xl font-bold text-gray-500">Microprocesador de 16 bits</h2>
                </div>

                <!-- Buses Principales (Ejes Centrales) -->
                <div class="bus bus-main" style="left: 10%; right: 10%; top: 250px; height: 10px;"></div> <!-- Eje Horizontal -->
                <div id="bus-main-vert" class="bus bus-main" style="top: 100px; bottom: 100px; left: 48%; width: 10px;"></div> <!-- Eje Vertical -->

                <!-- COMPONENTES -->
                <div id="pc" class="component" style="top: 100px; left: 10%;"><h3 class="font-bold">Contador (PC)</h3><p class="mono mt-1">0x1000</p></div>
                <div id="ri" class="component" style="top: 320px; left: 10%;"><h3 class="font-bold">Registro Inst. (RI)</h3><p class="mono mt-1">-</p></div>
                <div id="uc" class="component flex flex-col justify-center" style="top: 150px; left: 35%; width: 140px; height: 100px;">
                    <h3 class="font-bold">Unidad Control</h3>
                    <h4 class="font-semibold text-sm text-gray-400">(Decodificador)</h4>
                    <p id="uc-opcode-display" class="mono text-yellow-300 mt-1 text-xs">-</p>
                </div>
                <div id="acumulador" class="component" style="top: 320px; left: 30%;"><h3 class="font-bold">Acumulador</h3><p class="mono mt-1">0</p></div>
                <div id="operando2" class="component" style="top: 320px; left: 55%;"><h3 class="font-bold">Operando 2</h3><p class="mono mt-1">0</p></div>
                <div id="alu" class="component" style="top: 300px; right: 15%; width: 100px; height: 100px;"><h3 class="font-bold text-xl">ALU</h3></div>
                <div id="memoria" class="component" style="bottom: 10px; left: 10%; width: 200px; height: 150px;"><h3 class="font-bold">Memoria</h3><div id="memoria-content" class="text-left overflow-y-auto h-28 mt-1 bg-gray-800 p-1 rounded"></div></div>
                <div class="component" style="bottom: 10px; right: 10%;"><h3 class="font-bold">Entradas/Salidas</h3></div>
                
                <!-- Tabla de Codificación -->
                <div id="encoding-table" class="component" style="top: 20px; right: 2%; width: 220px;">
                    <h3 class="font-bold">Codificación de 16 bits</h3>
                    <div id="encoding-content-data" class="text-left mono mt-1 text-xs"></div>
                    <div id="encoding-content-inst" class="text-left mono mt-1 text-xs border-t border-gray-600 pt-1"></div>
                </div>

                <!-- BUSES DE CONEXIÓN Y ETIQUETAS -->
                <!-- Bus de Direcciones (Rojo) -->
                <div id="bus-addr-pc-horz" class="bus" style="top: 120px; left: 20%; width: 28%; height: 6px;"></div>
                <div id="bus-addr-main-vert" class="bus" style="bottom: 160px; left: 15%; width: 6px; height: 200px;"></div>
                <div id="bus-addr-main-horz" class="bus" style="bottom: 354px; left: 15%; width: 33%; height: 6px;"></div>
                <p class="bus-label text-red-500" style="top: 95px; left: 25%;">BUS DE DIRECCIONES</p>

                <!-- Bus de Datos (Azul) -->
                <div id="bus-data-ext-horz" class="bus" style="bottom: 300px; left: 20%; width: 28%; height: 6px;"></div>
                <div id="bus-data-ext-vert" class="bus" style="bottom: 160px; left: 20%; width: 6px; height: 140px;"></div>
                <div id="bus-data-main-horz" class="bus" style="top: 380px; left: 20%; right: 25%; height: 6px;"></div>
                <div id="bus-data-ri-conn" class="bus" style="left: 15%; top: 360px; height: 26px; width: 6px;"></div>
                <div id="bus-data-acum-conn" class="bus" style="left: 35%; top: 360px; height: 26px; width: 6px;"></div>
                <div id="bus-data-op2-conn" class="bus" style="left: 60%; top: 360px; height: 26px; width: 6px;"></div>
                <div id="bus-data-alu-out" class="bus" style="top: 350px; right: 25%; width: 10%; height: 6px;"></div>
                <div id="bus-data-alu-out-vert" class="bus" style="right: 25%; top: 350px; height: 36px; width: 6px;"></div>
                <p class="bus-label text-blue-500" style="top: 400px; left: 22%;">BUS DE DATOS</p>
                
                <!-- Bus de Control (Verde) -->
                <div id="bus-ctrl-uc-main" class="bus" style="top: 250px; left: 41%; width: 6px; height: 0px;"></div>
                <div id="bus-ctrl-bridge" class="bus" style="top: 180px; left: 41%; width: 7%; height: 6px;"></div>
                <div id="bus-ctrl-main-ext" class="bus" style="bottom: 80px; left: 55%; width: 6px; height: 200px;"></div>
                <div id="bus-ctrl-bridge-2" class="bus" style="bottom: 274px; left: 48%; width: 8%; height: 6px;"></div>
                 <p class="bus-label text-green-500" style="bottom: 150px; right: 38%; transform: rotate(-90deg);">BUS DE CONTROL</p>
            </div>

            <!-- Log -->
            <div id="log" class="component w-full min-h-[300px] bg-gray-900 p-4 overflow-y-auto" style="position: relative;">
                <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Registro de Simulación</h2>
                <div id="log-content"><p class="text-gray-500">Esperando inicio...</p></div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const autoRunBtn = document.getElementById('autoRunBtn');
        const nextStepBtn = document.getElementById('nextStepBtn');
        const resetBtn = document.getElementById('resetSim');
        const valAInput = document.getElementById('valA');
        const valBInput = document.getElementById('valB');
        const logContent = document.getElementById('log-content');
        const encodingContentData = document.getElementById('encoding-content-data');
        const encodingContentInst = document.getElementById('encoding-content-inst');
        const pcEl = document.getElementById('pc'), riEl = document.getElementById('ri'), ucEl = document.getElementById('uc'), aluEl = document.getElementById('alu'), acumuladorEl = document.getElementById('acumulador'), operando2El = document.getElementById('operando2'), memoriaEl = document.getElementById('memoria-content');
        const ucOpcodeDisplay = document.getElementById('uc-opcode-display');

        // --- Simulation State & Config ---
        let memory = {};
        const ADDR_A = '0x0001', ADDR_B = '0x0002', ADDR_RESULT = '0x0003', PROG_START = 0x1000, SIM_SPEED = 750;
        let stepQueue = [];
        let isAutoRunning = false;
        
        const program = [
            { addr: '0x1000', inst: 'LOAD_A', opcode: '0001000100010001', hexcode: '0x1111', val: ADDR_A, desc: `Cargar Acumulador desde dir. ${ADDR_A}`},
            { addr: '0x1001', inst: 'ADD', opcode: '0010001000100010', hexcode: '0x2222', val: ADDR_B, desc: `Sumar valor de dir. ${ADDR_B}`},
            { addr: '0x1002', inst: 'STORE', opcode: '0011001100110011', hexcode: '0x3333', val: ADDR_RESULT, desc: `Guardar resultado en dir. ${ADDR_RESULT}`},
            { addr: '0x1003', inst: 'HALT', opcode: '1111000011110000', hexcode: '0xF0F0', val: null, desc: 'Fin del programa' }
        ];

        // --- Functions ---
        function to16BitBinary(num) {
            return num.toString(2).padStart(16, '0');
        }
        function updateDataEncodingTable() {
            const valA = parseInt(valAInput.value, 10) || 0;
            const valB = parseInt(valBInput.value, 10) || 0;
            encodingContentData.innerHTML = `
                <b>Datos:</b>
                <p>Valor A (${valA}): ${to16BitBinary(valA)}</p>
                <p>Valor B (${valB}): ${to16BitBinary(valB)}</p>
            `;
        }
        function updateInstructionEncodingTable() {
            encodingContentInst.innerHTML = '<b>Instrucciones:</b>';
            program.forEach(p => {
                if (p.inst) {
                    encodingContentInst.innerHTML += `<p>${p.inst}: ${p.hexcode}</p>`;
                }
            });
        }

        function setupMemory() {
            memory = {};
            memory[ADDR_A] = parseInt(valAInput.value, 10) || 0;
            memory[ADDR_B] = parseInt(valBInput.value, 10) || 0;
            memory[ADDR_RESULT] = 0;
            program.forEach(p => { memory[p.addr] = p; });
            renderMemory();
            updateDataEncodingTable();
            updateInstructionEncodingTable();
        }
        function renderMemory() {
            memoriaEl.innerHTML = '';
            Object.keys(memory).sort().forEach(addr => {
                const val = memory[addr];
                const displayVal = typeof val === 'object' ? val.inst : val;
                 memoriaEl.innerHTML += `<div id="mem-${addr}" class="mono p-1 rounded"><b>${addr}:</b> ${displayVal}</div>`;
            });
        }
        function updateRegister(el, value) { el.querySelector('p').textContent = value; }
        function addLog(message, isStep = true) {
            const stepPrefix = isStep ? `<b>[Paso ${logContent.children.length + 1}]</b> ` : '';
            logContent.innerHTML += `<p class="mb-2 p-2 bg-gray-800 rounded-md shadow">${stepPrefix}${message}</p>`;
            logContent.scrollTop = logContent.scrollHeight;
        }

        const busPaths = {
            address: ['bus-addr-pc-horz', 'bus-main-vert', 'bus-addr-main-horz', 'bus-addr-main-vert'],
            data: ['bus-data-ext-vert', 'bus-data-ext-horz', 'bus-main-vert', 'bus-data-main-horz', 'bus-data-ri-conn', 'bus-data-acum-conn', 'bus-data-op2-conn', 'bus-data-alu-out', 'bus-data-alu-out-vert'],
            control: ['bus-ctrl-uc-main', 'bus-ctrl-bridge', 'bus-main-vert', 'bus-ctrl-bridge-2', 'bus-ctrl-main-ext']
        };
        function highlight(elements, type = 'component') {
            const highlightClass = `highlight-${type}`;
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add(highlightClass);
            });
        }
        function unhighlightAll() {
            const classes = ['highlight-component', 'highlight-bus-address', 'highlight-bus-data', 'highlight-bus-control'];
            document.querySelectorAll('.' + classes.join(', .')).forEach(el => el.classList.remove(...classes));
        }
        
        function addStep(logMessage, actionFn) {
            stepQueue.push(async () => {
                unhighlightAll();
                addLog(logMessage);
                if (actionFn) actionFn();
            });
        }

        function prepareSimulation() {
            stepQueue = [];
            let tempPC = PROG_START;
            let tempAcumulador = 0;
            setupMemory(); // Ensure memory is updated with current input values

            for(const instruction of program) {
                 if (instruction.inst === 'HALT') {
                    addStep("✅ **FIN:** El programa ha terminado.", () => {
                        highlight(['mem-' + ADDR_RESULT]);
                        disableButtons();
                    });
                    break;
                }
                const currentPCStr = `0x${tempPC.toString(16)}`;
                const operandAddr = instruction.val;
                
                // --- ETAPA 1: LECTURA (FETCH) ---
                addStep(`<b>1. Lectura (Fetch):</b> El PC (${currentPCStr}) envía la dirección a la Memoria.`, () => {
                    updateRegister(pcEl, currentPCStr);
                    highlight(['pc', 'memoria', ...busPaths.address], 'bus-address');
                    highlight(['pc', 'memoria']);
                });
                addStep(`... La instrucción ("${instruction.inst}") viaja desde la Memoria al Registro de Instrucción (RI).`, () => {
                    highlight(['memoria', 'ri', ...busPaths.data], 'bus-data');
                    highlight(['memoria', 'ri']);
                    updateRegister(riEl, `${instruction.inst} ${instruction.val || ''}`);
                    ucOpcodeDisplay.textContent = '-'; // Clear previous opcode
                });
                
                // --- ETAPA 2: DECODIFICACIÓN (DECODE) ---
                addStep(`<b>2. Decodificación (Decode):</b> La Unidad de Control interpreta la instrucción.`, () => {
                     highlight(['uc', 'ri']);
                });
                addStep(`... La instrucción se decodifica a su código binario de 16 bits: <span class="mono">${instruction.opcode}</span>.`, () => {
                    highlight(['uc', 'ri']);
                    ucOpcodeDisplay.textContent = instruction.opcode;
                });

                // --- ETAPA 3: INCREMENTO DEL PC ---
                addStep(`<b>3. Incremento del PC:</b> El Contador de Programa avanza a la siguiente dirección.`, () => {
                    highlight(['pc']);
                    updateRegister(pcEl, `0x${(tempPC + 1).toString(16)}`);
                });

                // --- ETAPA 4: EJECUCIÓN (EXECUTE) ---
                addStep(`<b>4. Ejecución (Execute):</b> Se ejecuta la instrucción "${instruction.inst}".`, () => {
                    highlight(['uc']);
                });

                switch (instruction.inst) {
                    case 'LOAD_A':
                        const valA = memory[operandAddr];
                        addStep(`... La UC busca el dato en la dirección ${operandAddr}.`, () => {
                            highlight(['uc', 'memoria', ...busPaths.address], 'bus-address');
                        });
                        addStep(`... El valor (${valA}) viaja de la Memoria al Acumulador.`, () => {
                            highlight(['memoria', 'acumulador', ...busPaths.data], 'bus-data');
                            tempAcumulador = valA;
                            updateRegister(acumuladorEl, tempAcumulador);
                        });
                        break;
                    case 'ADD':
                         const valB = memory[operandAddr];
                         addStep(`... La UC busca el dato en la dirección ${operandAddr}.`, () => {
                            highlight(['uc', 'memoria', ...busPaths.address], 'bus-address');
                        });
                        addStep(`... El valor (${valB}) viaja de la Memoria al Operando 2.`, () => {
                            highlight(['memoria', 'operando2', ...busPaths.data], 'bus-data');
                            updateRegister(operando2El, valB);
                        });
                        addStep(`... La ALU suma Acumulador (${tempAcumulador}) y Operando 2 (${valB}).`, () => {
                            highlight(['acumulador', 'operando2', 'alu', 'uc', ...busPaths.control], 'bus-control');
                        });
                        addStep(`... El resultado (${Number(tempAcumulador) + Number(valB)}) se guarda en el Acumulador.`, () => {
                            tempAcumulador = Number(tempAcumulador) + Number(valB);
                            highlight(['alu', 'acumulador', ...busPaths.data], 'bus-data');
                            updateRegister(acumuladorEl, tempAcumulador);
                        });
                        break;
                    case 'STORE':
                        addStep(`... El Acumulador (${tempAcumulador}) pone el resultado en el Bus de Datos.`, () => {
                             highlight(['acumulador', 'memoria', ...busPaths.data], 'bus-data');
                        });
                        addStep(`... La UC envía la dirección de destino (${operandAddr}) y la señal de 'escribir'.`, () => {
                             highlight(['uc', 'memoria', ...busPaths.address, ...busPaths.control], 'bus-control');
                             highlight(['uc', 'memoria', ...busPaths.address], 'bus-address');
                            memory[ADDR_RESULT] = tempAcumulador;
                            renderMemory();
                            document.getElementById('mem-' + ADDR_RESULT).classList.add('highlight-component');
                        });
                        break;
                }
                tempPC++;
            }
        }
        
        function ensureSimulationIsPrepared() {
            if (stepQueue.length === 0) {
                logContent.innerHTML = ''; 
                prepareSimulation();
            }
        }

        async function executeNextStep() {
            ensureSimulationIsPrepared();
            if (stepQueue.length > 0) {
                nextStepBtn.disabled = true;
                const step = stepQueue.shift();
                await step();
                if (stepQueue.length > 0) {
                    nextStepBtn.disabled = false;
                } else {
                    disableButtons();
                }
            }
        }
        
        async function autoRun() {
            ensureSimulationIsPrepared();
            isAutoRunning = true;
            disableButtons(true);
            while(isAutoRunning && stepQueue.length > 0) {
                const step = stepQueue.shift();
                await step();
                await new Promise(resolve => setTimeout(resolve, SIM_SPEED));
            }
            if (stepQueue.length === 0) {
                 disableButtons();
            }
        }
        
        function disableButtons(autoRunning = false){
            autoRunBtn.disabled = true;
            nextStepBtn.disabled = true;
            if(autoRunning) resetBtn.disabled = true;
        }

        function resetState() {
             isAutoRunning = false;
             stepQueue = []; 
             unhighlightAll();
             
             updateRegister(pcEl, `0x${PROG_START.toString(16)}`);
             updateRegister(riEl, '-');
             updateRegister(acumuladorEl, '0');
             updateRegister(operando2El, '0');
             ucOpcodeDisplay.textContent = '-';
             logContent.innerHTML = '<p class="text-gray-500" style="text-align: center;">Presiona "Siguiente Paso" o "Ejecución Automática"</p>';
             
             setupMemory();
             
             autoRunBtn.disabled = false;
             nextStepBtn.disabled = false;
             resetBtn.disabled = false;
        }
        
        // --- Event Listeners ---
        autoRunBtn.addEventListener('click', autoRun);
        nextStepBtn.addEventListener('click', executeNextStep);
        resetBtn.addEventListener('click', resetState);
        
        // --- Initial Setup ---
        resetState();
    </script>
</body>
</html>



